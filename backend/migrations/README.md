# Database Migrations

This directory contains Alembic database migrations for Wingman.

## Overview

Migrations track schema changes over time and allow you to upgrade/downgrade the database structure safely across environments.

## Common Commands

```bash
# Apply all pending migrations (use this in production)
mise run migrate

# Rollback the last migration
mise run migrate-down

# Show migration history
mise run migrate-history

# Show current database version
mise run migrate-current
```

## Creating New Migrations

When you modify models in `app/database.py`, create a migration:

```bash
# Start the database first
mise run up

# Generate migration from model changes
MIGRATION_MESSAGE="add user preferences table" mise run migrate-create

# Review the generated migration in migrations/versions/
# Then apply it
mise run migrate
```

## Migration Files

- `env.py` - Alembic environment configuration (imports app models)
- `script.py.mako` - Template for new migrations
- `versions/` - Migration files (one per schema change)

## Important Notes

- **Always review autogenerated migrations** before applying them
- Migrations run automatically when containers start (via entrypoint)
- Don't use `Base.metadata.create_all()` in productionâ€”use migrations instead
- Each migration has `upgrade()` and `downgrade()` functions
- Migration files are named with timestamp + description

## Workflow

1. Modify SQLAlchemy models in `app/database.py`
2. Generate migration: `MIGRATION_MESSAGE="your message" mise run migrate-create`
3. Review generated file in `migrations/versions/`
4. Test: `mise run migrate` to apply, `mise run migrate-down` to rollback
5. Commit migration file to git
6. Deploy: migrations run automatically on container startup
